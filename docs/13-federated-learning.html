---

title: Title
keywords: fastai
sidebar: home_sidebar

summary: "summary"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: notebooks/13-federated-learning.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
    
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Introducci&#243;n-a-Federated-Learning-o-Aprendizaje-Federado">Introducci&#243;n a Federated Learning o Aprendizaje Federado<a class="anchor-link" href="#Introducci&#243;n-a-Federated-Learning-o-Aprendizaje-Federado">&#182;</a></h1><h2 id="Problemas-de-privacidad-al-usar-Deep-Learning-y-otras-tecnicas-de-Machine-Learning">Problemas de privacidad al usar Deep Learning y otras tecnicas de Machine Learning<a class="anchor-link" href="#Problemas-de-privacidad-al-usar-Deep-Learning-y-otras-tecnicas-de-Machine-Learning">&#182;</a></h2><p>Es sabido que las redes neuronales o <code>deep learning</code> como se lo conoce ahora es un sub-area del campo de <code>Machine Learning</code>. Todo este grupo de algoritmos se caracterisa del resto de las otras áreas de la <code>Inteligencia Artificial</code> en que hecho de que su principal caracteristica es la capacidad que tienen de aprender utilizando datos, en lugar de usar reglas predefinidas. Pero muchas veces, los datos sobre los que se quiere crear un modelo de machine learning son datos muy personales y privados. Los mejores y más útiles modelos interactúan con los datos más personales de las personas y decirnos cosas sobre nosotros que hubiesen sido dificiles de saber de otra manera. Pero al mismo tiempo dar toda esta información requiere que confiemos en quien va a almacenar estos datos y que los cuidará para protejer nuestra privacidad, lo cual no siempre ocurre. Ejemplos de esto son:</p>
<ul>
<li><strong>Aplicaciones en Medicina</strong>: machine learning puede ayudar a mejorar dramáticamente diagnostico de enfermedades, como detección de tumores en imagenes de MRI, detectar con tiempo retinopatía diabética en imagenes de retina, detección de cancer en imagenes de melanoma, entre varias otras aplicaciónes más. Pero este tipo de datos son bastante sensibles ya que son datos de los pacientes, una filtración de este tipo de información sería muy grave.</li>
<li><strong>Recomendaciones</strong>: ya sea recomendacion de productos, contenido o publicidad, estos modelos buscan personalizar la interacción de los usuarios en los servicios que están utilizando. Mientras más información personal del usuario sea posible de obtener para el modelo de recomendación, mucho mejor será la experiencia del usuario final, que recibirá recomendaciones más significativas. En el 2018 se reveló que una empresa de Cambridge utilizó datos personales de varios usuarios de Facebook para crear un perfil psicológico de cada uno y poder crear campañas de desinformación a través de facebook, que recomendaba anunciós con discursos de odio, con  para influenciar campañas electorales en el 2016 en Estados Unidos, influenciar la salida de Inglaterra de la EU (Brexit) entre varios otros escandalos.<ul>
<li><a href="https://www.wikiwand.com/en/Facebook%E2%80%93Cambridge_Analytica_data_scandal">Facebook–Cambridge Analytica data scandal</a></li>
</ul>
</li>
<li><strong>Credit Scoring</strong>: modelos para saber que tan buenos pagadores de prestamos somos. Pueden utilizar informacion personal como historial crediticio, gastos varios y datos demograficos. Esta es información sensible que no querriamos que corra el riesgo de ser revelada a personas mal intencionadas. Por ejemplo, en el 2017 se reveló que Equifax ,una de las más grandes empresas que otorga credit scorings, entre varios otros servicios utilizando información personal de millones de personas, tuvo un breach enorme de información sensible de millones de personas.<ul>
<li><a href="https://www.wikiwand.com/en/Equifax#/Security_failings">Equifax Security Failing</a></li>
<li><a href="https://www.csoonline.com/article/3444488/equifax-data-breach-faq-what-happened-who-was-affected-what-was-the-impact.html">Equifax Breach: What Happened</a></li>
</ul>
</li>
</ul>
<p>Ya que los datos son el recurso primordial para modelos como las redes neuronales, y los casos de uso más significativos de los mismos requiere que interactúen con datos personales, es necesario encontrar una manera de acceder a los mismos sin correr el riesgo de violar la privacidad de las personas.</p>
<blockquote><p>Que pasaría si en lugar de acumular datos privados en un lugar centralizado para entrenar un modelo de deep learning, pudieramos enviar el modelo a donde se generan los datos y entrenar el modelo desde ahí, evitando así tener un solo punto de fallo desde el cual pueda ocurrir un <code>breach</code> de datos.</p>
</blockquote>
<p>Esto significa que: - Tecnicamente para poder participar en el entrenamiento de un modelo de deep learning, los usuarios no necesitan enviar sus datos a nadie, permitiendo así entrenar modelos valiosos con datos de salud, financieros, etc.- Personas y empresas que antes no podían compartir sus datos por cuestiones legales igual podrán generar valor gracias a ellos.</p>
<h2 id="Federated-Learning">Federated Learning<a class="anchor-link" href="#Federated-Learning">&#182;</a></h2><p>La premisa federated learning es que multiples datasets contienen información que es útil para resolver un problema, pero es dificil poder acceder a estos datasets en cantidades lo suficientemente grandes como para entrenar un modelo de deep learning que generalice lo suficientemente bien.</p>
<p>Si bien el dataset puede tener suficiente informacion para entrenar un modelo de deep learning, la principal preocupación es que este también pueda contener información que no tenga relación con el aprendizaje del modelo, pero que pueda causar daños a alguien si es revelada.</p>
<p><code>Federated Learning</code> se trata de enviar el modelo a un entorno seguro y aprender como resolver el problema sin la necesidad de mover los datos a ninguna parte. En este notebook veremos un ejemplo simple de <code>federated learning.</code></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Referencias">Referencias<a class="anchor-link" href="#Referencias">&#182;</a></h2><ul>
<li><a href="https://ai.googleblog.com/2017/04/federated-learning-collaborative.html">Federated Learning: Collaborative Machine Learning without Centralized Training Data</a></li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">module_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;..&#39;</span><span class="p">))</span>
<span class="k">if</span> <span class="n">module_path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">module_path</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">Counter</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">codecs</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">12345</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Caso-de-Ejemplo:-Detecci&#243;n-de-SPAM">Caso de Ejemplo: Detecci&#243;n de SPAM<a class="anchor-link" href="#Caso-de-Ejemplo:-Detecci&#243;n-de-SPAM">&#182;</a></h2><h3 id="Digamos-que-queremos-entrenar-un-modelo-para-detectar-spam-entre-los-correos-de-varias-personas">Digamos que queremos entrenar un modelo para detectar spam entre los correos de varias personas<a class="anchor-link" href="#Digamos-que-queremos-entrenar-un-modelo-para-detectar-spam-entre-los-correos-de-varias-personas">&#182;</a></h3><p>Este caso de uso se trata de clasificar correos. Para esto vamos a usar un dataset de correos de ENRON, un dataset publico bastante conocido, por el escandalo generado por dicha empresa.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Lectura-y-preprocesamiento-del-dataset">Lectura y preprocesamiento del dataset<a class="anchor-link" href="#Lectura-y-preprocesamiento-del-dataset">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">vocab</span><span class="p">,</span> <span class="n">spam</span><span class="p">,</span> <span class="n">ham</span> <span class="o">=</span> <span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="s2">&quot;&lt;unk&gt;&quot;</span><span class="p">]),</span> <span class="nb">list</span><span class="p">(),</span> <span class="nb">list</span><span class="p">())</span>

<span class="c1"># Lecrura de spam</span>
<span class="c1"># with codecs.open(&#39;datasets/enron-spam/spam.txt&#39;, &#39;r&#39;, encoding=&#39;utf-8&#39;, errors=&#39;ignore&#39;) as f:</span>
<span class="c1">#     raw = f.readlines()</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">codecs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;datasets/enron-spam/spam.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
<span class="n">raw</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;cantidad de mails de spam:&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">raw</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Un correo de ejemplo:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">raw</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="c1"># test = set(raw[0][:-2].split(&quot; &quot;))</span>
<span class="c1"># print(test)</span>
<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">raw</span><span class="p">:</span>
    <span class="c1"># se toma todas las palabras unicas de cada correo</span>
    <span class="n">spam</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">row</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)))</span>
    <span class="c1"># por cada una de las palabras del ultimo correo </span>
    <span class="c1"># agregado a la lista de spam</span>
    <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">spam</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
        <span class="c1"># se agregan todas las palabras nuevas al vocabulario</span>
        <span class="n">vocab</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>

<span class="c1"># Repetimos el mismo proceso para el archivo ham.txt</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">codecs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;datasets/enron-spam/ham.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
<span class="n">raw</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;cantidad de mails de ham:&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">raw</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Un correo de ejemplo:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">raw</span><span class="p">[</span><span class="mi">10</span><span class="p">])</span>
<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">raw</span><span class="p">:</span>
    <span class="n">ham</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">row</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">ham</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
        <span class="n">vocab</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>cantidad de mails de spam: 9000
Un correo de ejemplo:
 Subject: dobmeos with hgh my energy level has gone up ! stukm introducing doctor - formulated hgh human growth hormone - also called hgh is referred to in medical science as the master hormone . it is very plentiful when we are young , but near the age of twenty - one our bodies begin to produce less of it . by the time we are forty nearly everyone is deficient in hgh , and at eighty our production has normally diminished at least 90 - 95 % . advantages of hgh : - increased muscle strength - loss in body fat - increased bone density - lower blood pressure - quickens wound healing - reduces cellulite - improved vision - wrinkle disappearance - increased skin thickness texture - increased energy levels - improved sleep and emotional stability - improved memory and mental alertness - increased sexual potency - resistance to common illness - strengthened heart muscle - controlled cholesterol - controlled mood swings - new hair growth and color restore read more at this website unsubscribe 

cantidad de mails de ham: 22032
Un correo de ejemplo:
 Subject: entex transistion the purpose of the email is to recap the kickoff meeting held on yesterday with members from commercial and volume managment concernig the entex account : effective january 2000 , thu nguyen ( x 37159 ) in the volume managment group , will take over the responsibility of allocating the entex contracts . howard and thu began some training this month and will continue to transition the account over the next few months . entex will be thu &#39; s primary account especially during these first few months as she learns the allocations process and the contracts . howard will continue with his lead responsibilites within the group and be available for questions or as a backup , if necessary ( thanks howard for all your hard work on the account this year ! ) . in the initial phases of this transistion , i would like to organize an entex &#34; account &#34; team . the team ( members from front office to back office ) would meet at some point in the month to discuss any issues relating to the scheduling , allocations , settlements , contracts , deals , etc . this hopefully will give each of you a chance to not only identify and resolve issues before the finalization process , but to learn from each other relative to your respective areas and allow the newcomers to get up to speed on the account as well . i would encourage everyone to attend these meetings initially as i believe this is a critical part to the success of the entex account . i will have my assistant to coordinate the initial meeting for early 1 / 2000 . if anyone has any questions or concerns , please feel free to call me or stop by . thanks in advance for everyone &#39; s cooperation . . . . . . . . . . . julie - please add thu to the confirmations distributions list 

</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>El codigo anterior es solo preprocesamiento. Lo preprocesamos para tenerlo listo a la hora de hacer forwardprop utilizando <code>embeddings</code>. Algunas caracteristicas importantes del dataset preprocesado para poder entrenar el modelo son:</p>
<ul>
<li>Todas las palabras son convertidas en una lista de indices</li>
<li>Todos los correos son convertidos en listas de 500 palabras exactamente, ya sea recortandolos o rellenandolos con el token <code>&lt;unk&gt;</code>. Hacer esto hace que el dataset sea más fácil de procesar por el modelo</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Tomamos el vocabulario creado y creamos un diccionario</span>
<span class="c1"># con las palabras y sus indices</span>
<span class="n">vocab</span><span class="p">,</span> <span class="n">word2index</span> <span class="o">=</span> <span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">vocab</span><span class="p">),</span> <span class="p">{})</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">word</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vocab</span><span class="p">):</span>
    <span class="n">word2index</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>

<span class="k">def</span> <span class="nf">to_indices</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="mi">500</span><span class="p">):</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">input</span><span class="p">:</span>
        <span class="c1"># si la linea tiene menos palabras que l</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">l</span><span class="p">):</span>
            <span class="c1"># se completa la linea con el simbolo &lt;unk&gt; tantas</span>
            <span class="c1"># veces hasta llegar a una longitud l</span>
            <span class="n">line</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">+</span> <span class="p">([</span><span class="s1">&#39;&lt;unk&gt;&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">l</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)))</span>
            <span class="n">idxs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="n">idxs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">word2index</span><span class="p">[</span><span class="n">word</span><span class="p">])</span>
            <span class="n">indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idxs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">indices</span>
            
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Creacion-de-estructuras-de-datos-a-ser-utilizadas-para-el-entrenamiento-de-los-modelos">Creacion de estructuras de datos a ser utilizadas para el entrenamiento de los modelos<a class="anchor-link" href="#Creacion-de-estructuras-de-datos-a-ser-utilizadas-para-el-entrenamiento-de-los-modelos">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Se optienen los indices de spam y ham</span>
<span class="n">spam_idx</span> <span class="o">=</span> <span class="n">to_indices</span><span class="p">(</span><span class="n">spam</span><span class="p">)</span>
<span class="n">ham_idx</span> <span class="o">=</span> <span class="n">to_indices</span><span class="p">(</span><span class="n">ham</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Agrupamos ham y spam en listas para crear</span>
<span class="c1"># los conjuntos de prueba y entrenamiento</span>
<span class="n">train_spam_idx</span> <span class="o">=</span> <span class="n">spam_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1000</span><span class="p">]</span>
<span class="n">train_ham_idx</span> <span class="o">=</span> <span class="n">ham_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1000</span><span class="p">]</span>
<span class="n">test_spam_idx</span> <span class="o">=</span> <span class="n">spam_idx</span><span class="p">[</span><span class="o">-</span><span class="mi">1000</span><span class="p">:]</span>
<span class="n">test_ham_idx</span> <span class="o">=</span> <span class="n">ham_idx</span><span class="p">[</span><span class="o">-</span><span class="mi">1000</span><span class="p">:]</span>

<span class="c1"># Creamos los conjuntos de test y entrenamiento</span>
<span class="n">train_data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
<span class="n">train_target</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

<span class="n">test_data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
<span class="n">test_target</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">train_ham_idx</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_spam_idx</span><span class="p">))):</span>
    <span class="n">train_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">train_spam_idx</span><span class="p">[</span><span class="n">i</span><span class="o">%</span><span class="k">len</span>(train_spam_idx)])
    <span class="n">train_target</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span>
    
    <span class="n">train_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">train_ham_idx</span><span class="p">[</span><span class="n">i</span><span class="o">%</span><span class="k">len</span>(train_ham_idx)])
    <span class="n">train_target</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
    
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">test_ham_idx</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_spam_idx</span><span class="p">))):</span>
    <span class="n">test_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">test_spam_idx</span><span class="p">[</span><span class="n">i</span><span class="o">%</span><span class="k">len</span>(test_spam_idx)])
    <span class="n">test_target</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span>
    
    <span class="n">test_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">test_ham_idx</span><span class="p">[</span><span class="n">i</span><span class="o">%</span><span class="k">len</span>(test_ham_idx)])
    <span class="n">test_target</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Definicion-de-las-funciones-para-entrenar-y-testear-el-modelo">Definicion de las funciones para entrenar y testear el modelo<a class="anchor-link" href="#Definicion-de-las-funciones-para-entrenar-y-testear-el-modelo">&#182;</a></h3><p>Definimos las funciones que nos van a permitir inicializar, entrenar y evaluar el modelo centralizado de detección de spam.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">lightdlf_old.cpu.core</span> <span class="k">import</span> <span class="n">Tensor</span>
<span class="kn">from</span> <span class="nn">lightdlf_old.cpu.layers</span> <span class="k">import</span> <span class="n">Embedding</span><span class="p">,</span> <span class="n">MSELoss</span><span class="p">,</span> <span class="n">CrossEntropyLoss</span>
<span class="kn">from</span> <span class="nn">lightdlf_old.cpu.optimizers</span> <span class="k">import</span> <span class="n">SGD</span>
<span class="c1"># from lightdlf.cpu.core2 import Tensor, Embedding, MSELoss, SGD</span>

<span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">input_data</span><span class="p">,</span> <span class="n">target_data</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    
    <span class="n">criterion</span> <span class="o">=</span> <span class="n">MSELoss</span><span class="p">()</span>
    <span class="n">optim</span> <span class="o">=</span> <span class="n">SGD</span><span class="p">(</span><span class="n">parameters</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">get_parameters</span><span class="p">(),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
    
    <span class="n">n_batches</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span> <span class="o">/</span> <span class="n">batch_size</span><span class="p">)</span>
    <span class="k">for</span> <span class="nb">iter</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iterations</span><span class="p">):</span>
        <span class="n">iter_loss</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">b_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_batches</span><span class="p">):</span>

            <span class="c1"># el token auxiliar &lt;unk&gt; se tiene que quedar en 0</span>
            <span class="c1"># ya que no debe afectar al modelo</span>
            <span class="n">model</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">word2index</span><span class="p">[</span><span class="s1">&#39;&lt;unk&gt;&#39;</span><span class="p">]]</span> <span class="o">*=</span> <span class="mi">0</span> 
            <span class="nb">input</span> <span class="o">=</span> <span class="n">Tensor</span><span class="p">(</span><span class="n">input_data</span><span class="p">[</span><span class="n">b_i</span><span class="o">*</span><span class="n">batch_size</span><span class="p">:(</span><span class="n">b_i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">batch_size</span><span class="p">],</span> <span class="n">autograd</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">target</span> <span class="o">=</span> <span class="n">Tensor</span><span class="p">(</span><span class="n">target_data</span><span class="p">[</span><span class="n">b_i</span><span class="o">*</span><span class="n">batch_size</span><span class="p">:(</span><span class="n">b_i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">batch_size</span><span class="p">],</span> <span class="n">autograd</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">()</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span><span class="n">target</span><span class="p">)</span>
            <span class="c1"># loss.backward(Tensor(np.ones_like(loss.data)))</span>
            <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
            <span class="n">optim</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

            <span class="n">iter_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">batch_size</span>

            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r\t</span><span class="s2">Loss:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">iter_loss</span> <span class="o">/</span> <span class="p">(</span><span class="n">b_i</span><span class="o">+</span><span class="mi">1</span><span class="p">)))</span>
        <span class="nb">print</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">model</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">test</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">test_input</span><span class="p">,</span> <span class="n">test_output</span><span class="p">):</span>
    <span class="n">model</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">word2index</span><span class="p">[</span><span class="s1">&#39;&lt;unk&gt;&#39;</span><span class="p">]]</span> <span class="o">*=</span> <span class="mi">0</span>
    
    <span class="nb">input</span> <span class="o">=</span> <span class="n">Tensor</span><span class="p">(</span><span class="n">test_input</span><span class="p">,</span> <span class="n">autograd</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">target</span> <span class="o">=</span> <span class="n">Tensor</span><span class="p">(</span><span class="n">test_output</span><span class="p">,</span> <span class="n">autograd</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="n">pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">()</span>
    <span class="k">return</span> <span class="p">((</span><span class="n">pred</span><span class="o">.</span><span class="n">data</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">==</span> <span class="n">target</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Entrenamiento-de-un-modelo-Centralizado">Entrenamiento de un modelo Centralizado<a class="anchor-link" href="#Entrenamiento-de-un-modelo-Centralizado">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># model = Embedding(vocab_size=len(vocab), dim=2)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">Embedding</span><span class="p">(</span><span class="n">vocab_size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">vocab</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span> <span class="o">*=</span> <span class="mi">0</span>
<span class="n">criterion</span> <span class="o">=</span> <span class="n">MSELoss</span><span class="p">()</span>
<span class="n">optim</span> <span class="o">=</span> <span class="n">SGD</span><span class="p">(</span><span class="n">parameters</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">get_parameters</span><span class="p">(),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">train</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">train_data</span><span class="p">,</span> <span class="n">train_target</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;% Correcto en el conjunto de entrenamiento: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">test</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">test_data</span><span class="p">,</span> <span class="n">test_target</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>	Loss:0.037140416860871446
% Correcto en el conjunto de entrenamiento: 98.65
	Loss:0.011258669226059108
% Correcto en el conjunto de entrenamiento: 99.15
	Loss:0.008068268387986223
% Correcto en el conjunto de entrenamiento: 99.45
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Luego de 3 iteraciones logramos entrenar un modelo que puede predecir correos de spam con una precision del <code>99.45%</code></p>
<h3 id="Analisis-de-los-embedings-generados">Analisis de los embedings generados<a class="anchor-link" href="#Analisis-de-los-embedings-generados">&#182;</a></h3><p>Hemos generado un modelo donde todos los <code>embeddings</code> tienen una dimension de 1, veamos los <code>embeddings</code> de palabras comunes en correos de spam y comunes en correos normales de una empresa</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Palabras comunes en correos de spam:&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">- palabra: penis&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">idx:&#39;</span><span class="p">,</span> <span class="n">word2index</span><span class="p">[</span><span class="s1">&#39;penis&#39;</span><span class="p">],</span> <span class="s1">&#39;,</span><span class="se">\n\t</span><span class="s1">embedding:&#39;</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">word2index</span><span class="p">[</span><span class="s1">&#39;penis&#39;</span><span class="p">]],</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">- palabra: viagra&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">idx:&#39;</span><span class="p">,</span> <span class="n">word2index</span><span class="p">[</span><span class="s1">&#39;viagra&#39;</span><span class="p">],</span> <span class="s1">&#39;,</span><span class="se">\n\t</span><span class="s1">embedding:&#39;</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">word2index</span><span class="p">[</span><span class="s1">&#39;viagra&#39;</span><span class="p">]],</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">- palabra: spam&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">idx:&#39;</span><span class="p">,</span> <span class="n">word2index</span><span class="p">[</span><span class="s1">&#39;spam&#39;</span><span class="p">],</span> <span class="s1">&#39;,</span><span class="se">\n\t</span><span class="s1">embedding:&#39;</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">word2index</span><span class="p">[</span><span class="s1">&#39;spam&#39;</span><span class="p">]],</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="c1"># print(&#39;- palabra: cocaine&#39;, &#39;\nidx:&#39;, word2index[&#39;cocaine&#39;], &#39;,\nembedding:&#39;, model.weight.data[word2index[&#39;cocaine&#39;]], &#39;\n&#39;)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Palabras comunes en correos normales&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">- palabra: critical&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">idx:&#39;</span><span class="p">,</span> <span class="n">word2index</span><span class="p">[</span><span class="s1">&#39;critical&#39;</span><span class="p">],</span> <span class="s1">&#39;,</span><span class="se">\n\t</span><span class="s1">embedding:&#39;</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">word2index</span><span class="p">[</span><span class="s1">&#39;critical&#39;</span><span class="p">]],</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">- palabra: assistant&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">idx:&#39;</span><span class="p">,</span> <span class="n">word2index</span><span class="p">[</span><span class="s1">&#39;assistant&#39;</span><span class="p">],</span> <span class="s1">&#39;,</span><span class="se">\n\t</span><span class="s1">embedding:&#39;</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">word2index</span><span class="p">[</span><span class="s1">&#39;assistant&#39;</span><span class="p">]],</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">- palabra: meetings&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">idx:&#39;</span><span class="p">,</span> <span class="n">word2index</span><span class="p">[</span><span class="s1">&#39;meetings&#39;</span><span class="p">],</span> <span class="s1">&#39;,</span><span class="se">\n\t</span><span class="s1">embedding:&#39;</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">word2index</span><span class="p">[</span><span class="s1">&#39;meetings&#39;</span><span class="p">]],</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Palabras comunes en correos de spam:
	- palabra: penis 
	idx: 45229 ,
	embedding: [0.09662769] 

	- palabra: viagra 
	idx: 20503 ,
	embedding: [0.20160151] 

	- palabra: spam 
	idx: 5850 ,
	embedding: [0.11120405] 

Palabras comunes en correos normales
	- palabra: critical 
	idx: 49238 ,
	embedding: [-0.02622459] 

	- palabra: assistant 
	idx: 27749 ,
	embedding: [-0.02255735] 

	- palabra: meetings 
	idx: 47376 ,
	embedding: [-0.02443877] 

</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Podemos ver que los embeddings de palabras comunes en correos de spam tienen un valor positivo, mientras que las palabras comunes en correos normales tienden a valores negativos, esto es porque estamos usando la función <code>sigmoide</code> para poder clasificar estos correos, donde:</p>
<ul>
<li>0 = todos los correos normales o <code>ham</code></li>
<li>1 = todos los correos que son <code>spam</code></li>
</ul>
<p>En la función <code>sigmoide</code>, los valores por debajo de 0 tienden a tendrán como valor <code>0.5 o menos</code>, como nuestro modelo es un modelo conocido como <code>bag of words</code>, si las palabras comunes en un correo de spam tienen un valor negativo, mientras, más de estas haya en un correo, estas sumarán un numero muy por debajo de 0, por lo que la función <code>sigmoide</code> tenderá a 0, esto se puede ver claramente en los embeddings de las palabras más arriba</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Federated-Learning:-Volviendo-el-modelo-Centralizado-en-uno-Federado">Federated Learning: Volviendo el modelo Centralizado en uno Federado<a class="anchor-link" href="#Federated-Learning:-Volviendo-el-modelo-Centralizado-en-uno-Federado">&#182;</a></h2><p>El ejemplo anterior es la forma tradicional de entrenar un modelo de machine learning en donde:</p>
<ol>
<li>Cada usuario envia sus datos a un servidor central</li>
<li>El servidor central entrena un modelo global en base a los datos</li>
<li>El modelo y los datos quedan en el servidor central</li>
</ol>
<p>Al tener todos los datos en un servidor central, tenemos el problema que habíamos menciondo, de el cliente pierde el control de sus datos y por ende de su privacidad. Un breach en el servidor central es suficiente para vulnerar la privacidad de miles de usuarios.</p>
<p>Como habíamos mencionado, la solucion a este problema es utilizar federated learning. Para ello simulemos un entorno de entrenamiento donde tengamos usuarios con multiples colecciones diferentes de correos</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">bob</span> <span class="o">=</span> <span class="p">(</span><span class="n">train_data</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1000</span><span class="p">],</span> <span class="n">train_target</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1000</span><span class="p">])</span>
<span class="n">alice</span> <span class="o">=</span> <span class="p">(</span><span class="n">train_data</span><span class="p">[</span><span class="mi">1000</span><span class="p">:</span><span class="mi">2000</span><span class="p">],</span> <span class="n">train_target</span><span class="p">[</span><span class="mi">1000</span><span class="p">:</span><span class="mi">2000</span><span class="p">])</span>
<span class="n">sue</span> <span class="o">=</span> <span class="p">(</span><span class="n">train_data</span><span class="p">[</span><span class="mi">2000</span><span class="p">:],</span> <span class="n">train_target</span><span class="p">[</span><span class="mi">2000</span><span class="p">:])</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;cantidad de correos por usuario&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;- bob&#39;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">bob</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;- alice&#39;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">alice</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;- sue&#39;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">sue</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>cantidad de correos por usuario
- bob 1000
- alice 1000
- sue 39908
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Ahora que tenemos estos tres datasets, podemos hacer el mismo entrenamiento que habíamos hecho anteriormente</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">Embedding</span><span class="p">(</span><span class="n">vocab_size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">vocab</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span> <span class="o">*=</span> <span class="mi">0</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">copy</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="c1"># Tomamos el modelo que inicializamos y por cada set de datos</span>
    <span class="c1"># Creamos una copia del modelo (deepcopy) y entrenamos</span>
    <span class="c1"># un modelo por cada conjunto de datos</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Iniciando la ronda de entrenamiento...&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Paso 1: enviamos el modelo a Bob&#39;</span><span class="p">)</span>
    <span class="n">bob_model</span> <span class="o">=</span> <span class="n">train</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">model</span><span class="p">),</span> <span class="n">bob</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bob</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">iterations</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">Paso 2: enviamos el modelo a Alice&#39;</span><span class="p">)</span>
    <span class="n">alice_model</span> <span class="o">=</span> <span class="n">train</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">model</span><span class="p">),</span> <span class="n">alice</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">alice</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">iterations</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">Paso 3: enviamos el modelo a Sue&#39;</span><span class="p">)</span>
    <span class="n">sue_model</span> <span class="o">=</span> <span class="n">train</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">model</span><span class="p">),</span> <span class="n">sue</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sue</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">iterations</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">Modelo promedio de todos los modelos&#39;</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">bob_model</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span> <span class="o">+</span> \
                         <span class="n">alice_model</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span> <span class="o">+</span> \
                         <span class="n">sue_model</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">% Correcto en el conjunto de entrenamiento: &#39;</span> <span class="o">+</span> \
          <span class="nb">str</span><span class="p">(</span><span class="n">test</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">test_data</span><span class="p">,</span> <span class="n">test_target</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Iteramos</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Iniciando la ronda de entrenamiento...
	Paso 1: enviamos el modelo a Bob
	Loss:0.21908166249699718

	Paso 2: enviamos el modelo a Alice
	Loss:0.2937106899184867

	Paso 3: enviamos el modelo a Sue
	Loss:0.03333996697717589

	Modelo promedio de todos los modelos
	% Correcto en el conjunto de entrenamiento: 84.05
Iteramos

Iniciando la ronda de entrenamiento...
	Paso 1: enviamos el modelo a Bob
	Loss:0.0662536748363041

	Paso 2: enviamos el modelo a Alice
	Loss:0.0959537422555682

	Paso 3: enviamos el modelo a Sue
	Loss:0.02029024788114074

	Modelo promedio de todos los modelos
	% Correcto en el conjunto de entrenamiento: 92.25
Iteramos

Iniciando la ronda de entrenamiento...
	Paso 1: enviamos el modelo a Bob
	Loss:0.030819682914453826

	Paso 2: enviamos el modelo a Alice
	Loss:0.03580324891736089

	Paso 3: enviamos el modelo a Sue
	Loss:0.01536846160847025

	Modelo promedio de todos los modelos
	% Correcto en el conjunto de entrenamiento: 98.8
Iteramos

</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Entrenando de esta manera obtenemos un modelo con casi el mismo rendimiento que el modelo centralizado, y en teoría no necesitamos tener acceso a los datos de entrenamiento para que cada usuario cambie el modelo de alguna manera.</p>
<p>De esta manera, es posible descubrir algo de los datasets con los que se está entrenando? Que de alguna manera, durante el entrenamiento, se pueda descubrir algo del dataset de un usuario y así vulnerar la privacidad del mismo?</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Vulnerando-Federated-Learning">Vulnerando Federated Learning<a class="anchor-link" href="#Vulnerando-Federated-Learning">&#182;</a></h2><p><em>Veamos un ejemplo en donde como es posible que un modelo memorice información del conjunto de entrenamiento y por ende, vulnerar la privacidad de un usuario.</em></p>
<p>Federated Learning tiene dos grandes desafíos:</p>
<ul>
<li>Rendimiento o Performance</li>
<li>Privacidad</li>
</ul>
<p>Los cuales son más difíciles de manejar cuando cada usuario tiene un dataset de entrenamiento con muy pocos ejemplos. Si tenemos miles de ususarios, cada uno con muy pocos ejemplos pasa que:</p>
<ol>
<li>El modelo en lugar de generalizar, empieza a memorizar los datos utilizados para su entrenamiento.</li>
<li>Se pasa más tiempo enviando y recibiendo el modelo de los usuarios y poco tiempo entrenando el modelo en sí.</li>
</ol>
<p>Miremos un ejemplo donde uno de los usuarios tiene muy pocos ejemplos de datos</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">bobs_email</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;my&quot;</span><span class="p">,</span> <span class="s2">&quot;computer&quot;</span><span class="p">,</span> <span class="s2">&quot;password&quot;</span><span class="p">,</span> <span class="s2">&quot;is&quot;</span><span class="p">,</span> <span class="s2">&quot;pizza&quot;</span><span class="p">]</span>

<span class="n">bob_input</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">word2index</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">bobs_email</span><span class="p">]])</span>
<span class="n">bob_target</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">Embedding</span><span class="p">(</span><span class="n">vocab_size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">vocab</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span> <span class="o">*=</span> <span class="mi">0</span>

<span class="n">bobs_model</span> <span class="o">=</span> <span class="n">train</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">model</span><span class="p">),</span> 
                   <span class="n">bob_input</span><span class="p">,</span> 
                   <span class="n">bob_target</span><span class="p">,</span> 
                   <span class="n">iterations</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
                   <span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>	Loss:0.25
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Entrenamos el modelo de bob, pero bob solo tenía un correo, y no solamente eso, dicho correo contenía información sensible sobre como acceder a su computadora. Ahora, lo que nosotros obtuvimos es un modelo, no los datos de bob. Aún así, es posible vulnerar la privacidad de bob?</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span> <span class="o">-</span> <span class="n">bobs_model</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="p">):</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">vocab</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>password
computer
pizza
is
my
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Y así como así, solo se necesitó saber como variaron los pesos al actualizar el modelo para poder descubrir la contraseña de la computadora de bob, violando así su privacidad.</p>
<p>Que pasaría si pudieramos encriptar los modelos, realizar operaciones sobre el mismo y luego desencriptarlo para proteger la información?</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Cifrado-homom&#243;rfico">Cifrado homom&#243;rfico<a class="anchor-link" href="#Cifrado-homom&#243;rfico">&#182;</a></h2><p><em>Realizar operaciones aritmeticas sobre valores encriptados es posible</em></p>
<p>Básicamente poder realizar operaciones aritméticas sobre valores encriptados se llama cifrado homomorfico. Cifrado Homomorfico es toda un área de investigacion en sí misma, en este notebook nos vamos a centrar en la capacidad de realizar adiciones entre valores encriptados. Contamos con:</p>
<ul>
<li>Una clave pública para encriptar los valores y</li>
<li>Una clave privada para desencriptar los valores</li>
</ul>
<p>Veamos un ejemplo de esto:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># En caso de ser la primera vez que se corre este notebook </span>
<span class="c1"># y no se tiene la libreria phe, instalarla con la siguiente linea</span>
<span class="c1"># https://github.com/n1analytics/python-paillier</span>
<span class="c1"># !pip install phe</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">phe</span>
<span class="n">public_key</span><span class="p">,</span> <span class="n">private_key</span> <span class="o">=</span> <span class="n">phe</span><span class="o">.</span><span class="n">generate_paillier_keypair</span><span class="p">(</span><span class="n">n_length</span><span class="o">=</span><span class="mi">1024</span><span class="p">)</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">public_key</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">public_key</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

<span class="n">z</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>

<span class="n">z_plain</span> <span class="o">=</span> <span class="n">private_key</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;El valor de z es:&#39;</span><span class="p">,</span> <span class="n">z_plain</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>El valor de z es: 8
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Otras operacioes posibles con encriptacion o cifrado homomorfico</span>
<span class="n">w</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">w_plain</span> <span class="o">=</span> <span class="n">private_key</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;El valor de w es:&#39;</span><span class="p">,</span> <span class="n">w_plain</span><span class="p">)</span>
<span class="n">w</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="mi">2</span>
<span class="n">w_plain</span> <span class="o">=</span> <span class="n">private_key</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;El valor de w es:&#39;</span><span class="p">,</span> <span class="n">w_plain</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>El valor de w es: 6
El valor de w es: 10
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Hagamos un ejemplo de lo que sería entrenar un modelo con encriptación homomorfica. Primero creemos una funcion que nos permita encriptar un modelo que hayamos entrenado</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">train_and_encrypt</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">pubkey</span><span class="p">):</span>
    <span class="c1"># A fines demostrativos, esta funcion solo funciona </span>
    <span class="c1"># para Embeddings con una sola dimension</span>
    <span class="n">new_model</span> <span class="o">=</span> <span class="n">train</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">model</span><span class="p">),</span> <span class="nb">input</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="n">encrypt_weights</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">new_model</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">encrypt_weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">public_key</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
    <span class="n">ew</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">encrypt_weights</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">new_model</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">ew</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">Embedding</span><span class="p">(</span><span class="n">vocab_size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">vocab</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span> <span class="o">*=</span> <span class="mi">0</span>

<span class="n">public_key</span><span class="p">,</span> <span class="n">private_key</span> <span class="o">=</span> <span class="n">phe</span><span class="o">.</span><span class="n">generate_paillier_keypair</span><span class="p">(</span><span class="n">n_length</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Iniciando la Iteracion de entrenamiento...&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Paso 1: enviar modelo a Bob&#39;</span><span class="p">)</span>
    <span class="n">bob_encrypted_model</span> <span class="o">=</span> <span class="n">train_and_encrypt</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">model</span><span class="p">),</span>
                                            <span class="n">bob</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bob</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">public_key</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">Paso 2: enviar modelo a Alice&#39;</span><span class="p">)</span>
    <span class="n">alice_encrypted_model</span> <span class="o">=</span> <span class="n">train_and_encrypt</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">model</span><span class="p">),</span>
                                           <span class="n">alice</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">alice</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">public_key</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">Paso 1: enviar modelo a Sue&#39;</span><span class="p">)</span>
    <span class="n">sue_encrypted_model</span> <span class="o">=</span> <span class="n">train_and_encrypt</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">model</span><span class="p">),</span>
                                           <span class="n">sue</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sue</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">public_key</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">Paso 4: Bob, Alice y Sue envian&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">y agregan sus modelos encriptados ente sí&#39;</span><span class="p">)</span>
    <span class="n">aggregated_model</span> <span class="o">=</span> <span class="n">bob_encrypted_model</span> <span class="o">+</span> \
                       <span class="n">alice_encrypted_model</span> <span class="o">+</span> \
                       <span class="n">sue_encrypted_model</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">Paso 5: Solo el modelo agregado&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">se envia devuelta al dueño del modelo&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">que puede desencriptarlo&#39;</span><span class="p">)</span>
    <span class="n">raw_values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">aggregated_model</span><span class="o">.</span><span class="n">flatten</span><span class="p">():</span>
        <span class="n">raw_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">private_key</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
    <span class="n">model</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">raw_values</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Correctos en el conjunto de prueba:&quot;</span> <span class="o">+</span> \
          <span class="nb">str</span><span class="p">(</span><span class="n">test</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">test_data</span><span class="p">,</span> <span class="n">test_target</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>
Iniciando la Iteracion de entrenamiento...
	Paso 1: enviar modelo a Bob
	Loss:0.21908166249699718

	Paso 2: enviar modelo a Alice
	Loss:0.2937106899184867

	Paso 1: enviar modelo a Sue
	Loss:0.03333996697717589

	Paso 4: Bob, Alice y Sue envian
	y agregan sus modelos encriptados ente sí

	Paso 5: Solo el modelo agregado
	se envia devuelta al dueño del modelo
	que puede desencriptarlo
	Correctos en el conjunto de prueba:84.05

Iniciando la Iteracion de entrenamiento...
	Paso 1: enviar modelo a Bob
	Loss:0.0662536748363041

	Paso 2: enviar modelo a Alice
	Loss:0.09595374225556819

	Paso 1: enviar modelo a Sue
	Loss:0.02029024788114074

	Paso 4: Bob, Alice y Sue envian
	y agregan sus modelos encriptados ente sí

	Paso 5: Solo el modelo agregado
	se envia devuelta al dueño del modelo
	que puede desencriptarlo
	Correctos en el conjunto de prueba:92.25

Iniciando la Iteracion de entrenamiento...
	Paso 1: enviar modelo a Bob
	Loss:0.030819682914453833

	Paso 2: enviar modelo a Alice
	Loss:0.0358032489173609

	Paso 1: enviar modelo a Sue
	Loss:0.01536846160847025

	Paso 4: Bob, Alice y Sue envian
	y agregan sus modelos encriptados ente sí

	Paso 5: Solo el modelo agregado
	se envia devuelta al dueño del modelo
	que puede desencriptarlo
	Correctos en el conjunto de prueba:98.8

Iniciando la Iteracion de entrenamiento...
	Paso 1: enviar modelo a Bob
	Loss:0.017275589333002585

	Paso 2: enviar modelo a Alice
	Loss:0.018830500591261824

	Paso 1: enviar modelo a Sue
	Loss:0.012752285302780164

	Paso 4: Bob, Alice y Sue envian
	y agregan sus modelos encriptados ente sí

	Paso 5: Solo el modelo agregado
	se envia devuelta al dueño del modelo
	que puede desencriptarlo
	Correctos en el conjunto de prueba:99.05000000000001
</pre>
</div>
</div>

</div>
</div>

</div>
</div>
 

